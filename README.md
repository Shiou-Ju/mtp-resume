# mtp-resume
MTP æª”æ¡ˆå‚³è¼¸å·¥å…·ï¼Œè§£æ±ºéƒ¨åˆ†å¥—ä»¶å‚³è¼¸å¤§é‡æª”æ¡ˆæ™‚å¡ä½çš„å•é¡Œ

## å°ˆæ¡ˆæ¦‚è¿°
é–‹ç™¼ä¸€å€‹ç©©å®šå¯é çš„ MTP æª”æ¡ˆå‚³è¼¸å·¥å…·ï¼Œè§£æ±º OpenMTP å‚³è¼¸å¤§é‡æª”æ¡ˆæ™‚å¡ä½çš„å•é¡Œï¼Œä¸¦æä¾›æ™ºæ…§çºŒå‚³åŠŸèƒ½ã€‚

## ğŸ¯ å°ˆæ¡ˆç‰¹é»èˆ‡å¸‚å ´å·®ç•°åŒ–

### ğŸ”¥ ç¨ç‰¹è³£é»
æ ¹æ“šå¸‚å ´èª¿æŸ¥ï¼Œ**ç›®å‰æ²’æœ‰å°ˆé–€çš„ MTP çºŒå‚³å·¥å…·**ï¼æœ¬å°ˆæ¡ˆå¡«è£œäº†é‡è¦çš„å¸‚å ´ç©ºç¼ºï¼š

- **å°ˆæ³¨çºŒå‚³**ï¼šç¾æœ‰å·¥å…·éƒ½æ²’æœ‰å°‡çºŒå‚³ä½œç‚ºæ ¸å¿ƒåŠŸèƒ½
- **CLI å„ªå…ˆ**ï¼šå¤§éƒ¨åˆ†æ˜¯ GUI å·¥å…·ï¼ŒCLI å·¥å…·è¼ƒå°‘ä¸”åŠŸèƒ½æœ‰é™
- **è·¨å¹³å°**ï¼šè¨±å¤šå·¥å…·åªæ”¯æ´å–®ä¸€å¹³å°
- **ç°¡å–®å¯é **ï¼šä¸éœ€è¦è¤‡é›œè¨­å®šã€root æ¬Šé™æˆ–é–‹ç™¼è€…æ¨¡å¼

### ğŸ†š èˆ‡ç¾æœ‰å·¥å…·æ¯”è¼ƒ

| å·¥å…· | çºŒå‚³åŠŸèƒ½ | CLIæ”¯æ´ | æ‰¹æ¬¡è™•ç† | è·¨å¹³å° | å•é¡Œ |
|------|---------|---------|----------|--------|------|
| **OpenMTP** | âŒ | âŒ | âš ï¸ | âœ… | å¤§é‡æª”æ¡ˆæ™‚å¡ä½ |
| **android-file-transfer** | âŒ | âš ï¸ | âŒ | âš ï¸ | åŠŸèƒ½æœ‰é™ |
| **rsync + MTP** | âš ï¸ | âœ… | âš ï¸ | âœ… | éå¸¸æ…¢ï¼Œé…ç½®è¤‡é›œ |
| **gMTP** | âŒ | âŒ | âŒ | âŒ | åƒ… Linux |
| **mtp-resume** | âœ… | âœ… | âœ… | âœ… | ç„¡å·²çŸ¥å•é¡Œ |

### ğŸ¯ ç›®æ¨™ç”¨æˆ¶
- éœ€è¦å‚³è¼¸å¤§é‡ç…§ç‰‡/å½±ç‰‡çš„ä½¿ç”¨è€…
- ç¶“å¸¸é‡åˆ°å‚³è¼¸ä¸­æ–·çš„æƒ…æ³
- åå¥½å‘½ä»¤åˆ—æ“ä½œçš„æŠ€è¡“ä½¿ç”¨è€…
- è¿½æ±‚æ•ˆç‡å’Œå¯é æ€§çš„å°ˆæ¥­ç”¨æˆ¶

## æ ¸å¿ƒåŠŸèƒ½
- **æ™ºæ…§çºŒå‚³**ï¼šè¨˜éŒ„å‚³è¼¸é€²åº¦ï¼Œæ”¯æ´æ–·é»çºŒå‚³
- **ç©©å®šå‚³è¼¸**ï¼šèƒ½è™•ç†å¤§æª”æ¡ˆå’ŒéŒ¯èª¤æƒ…æ³
- **é›™ä»‹é¢æ”¯æ´**ï¼šCLI å¿«é€Ÿæ“ä½œï¼ŒGUI å‹å–„ä»‹é¢
- **é€²åº¦æŒä¹…åŒ–**ï¼šSQLite è³‡æ–™åº«ä¿å­˜å‚³è¼¸ç‹€æ…‹
- **æ‰¹æ¬¡è™•ç†**ï¼šé«˜æ•ˆè™•ç†å¤§é‡æª”æ¡ˆ
- **éŒ¯èª¤æ¢å¾©**ï¼šè‡ªå‹•è·³éå•é¡Œæª”æ¡ˆï¼Œç¹¼çºŒå‚³è¼¸

### æŠ€è¡“æ¶æ§‹

#### Monorepo çµæ§‹
```
mtp-transfer/
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ core/              # æ ¸å¿ƒé‚è¼¯å¥—ä»¶
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ mtp-wrapper.js     # MTP æ“ä½œå°è£
â”‚   â”‚   â”‚   â”œâ”€â”€ transfer-manager.js # å‚³è¼¸ç®¡ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ database.js        # è³‡æ–™åº«æ“ä½œ
â”‚   â”‚   â”‚   â””â”€â”€ file-differ.js     # æª”æ¡ˆæ¯”å°é‚è¼¯
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â”œâ”€â”€ cli/               # CLI ä»‹é¢
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â””â”€â”€ index.js
â”‚   â”‚   â””â”€â”€ package.json
â”‚   â”‚
â”‚   â””â”€â”€ gui/               # GUI ä»‹é¢ (æœªä¾†é–‹ç™¼)
â”‚       â””â”€â”€ package.json
â”‚
â”œâ”€â”€ pnpm-workspace.yaml
â””â”€â”€ package.json
```

#### pnpm-workspace.yaml
```yaml
packages:
  - 'packages/*'
```

### è³‡æ–™åº«è¨­è¨ˆ

```sql
-- ç°¡åŒ–çš„å‚³è¼¸è¨˜éŒ„è¡¨
CREATE TABLE transfers (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  file_path TEXT NOT NULL,
  file_size INTEGER NOT NULL,
  status TEXT DEFAULT 'pending',
  error TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(file_path, file_size)
);

CREATE INDEX idx_status ON transfers(status);
CREATE INDEX idx_file_path ON transfers(file_path);
```

### æ ¸å¿ƒæ¨¡çµ„è¨­è¨ˆ

#### 1. MTP Wrapper (packages/core/src/mtp-wrapper.js)
```javascript
const { exec } = require('child_process');
const util = require('util');
const execAsync = util.promisify(exec);

class MTPWrapper {
  async detectDevice() {
    try {
      const { stdout } = await execAsync('mtp-detect');
      return this.parseDeviceInfo(stdout);
    } catch (error) {
      throw new Error(`è£ç½®åµæ¸¬å¤±æ•—: ${error.message}`);
    }
  }

  async listFiles() {
    const { stdout } = await execAsync('mtp-files');
    return this.parseFileList(stdout);
  }

  async downloadFile(fileId, destination) {
    await execAsync(`mtp-getfile ${fileId} "${destination}"`);
  }

  parseFileList(output) {
    // è§£æ mtp-files è¼¸å‡º
    // å›å‚³æ ¼å¼: [{ id, path, size }]
  }
}

module.exports = MTPWrapper;
```

#### 2. Transfer Manager (packages/core/src/transfer-manager.js)
```javascript
class TransferManager {
  constructor({ db, onProgress, onError }) {
    this.db = db;
    this.onProgress = onProgress || (() => {});
    this.onError = onError || (() => {});
  }

  async getPendingFiles(phoneFiles) {
    const pending = [];
    
    for (const file of phoneFiles) {
      const record = this.db.prepare(
        'SELECT status FROM transfers WHERE file_path = ? AND file_size = ?'
      ).get(file.path, file.size);
      
      if (!record || record.status !== 'completed') {
        pending.push(file);
      }
    }
    
    return pending;
  }

  async transferFile(file, destination) {
    try {
      // æ›´æ–°ç‹€æ…‹ç‚ºå‚³è¼¸ä¸­
      this.updateStatus(file.path, file.size, 'transferring');
      
      // åŸ·è¡Œå‚³è¼¸
      await this.mtp.downloadFile(file.id, destination);
      
      // æ¨™è¨˜å®Œæˆ
      this.updateStatus(file.path, file.size, 'completed');
      
      // é€šçŸ¥é€²åº¦
      this.onProgress({
        file: file.path,
        status: 'completed'
      });
    } catch (error) {
      this.updateStatus(file.path, file.size, 'failed', error.message);
      this.onError({ file: file.path, error });
    }
  }

  updateStatus(filePath, fileSize, status, error = null) {
    this.db.prepare(`
      INSERT OR REPLACE INTO transfers 
      (file_path, file_size, status, error, updated_at)
      VALUES (?, ?, ?, ?, datetime('now'))
    `).run(filePath, fileSize, status, error);
  }
}

module.exports = TransferManager;
```

#### 3. è³‡æ–™åº«ç®¡ç† (packages/core/src/database.js)
```javascript
const Database = require('better-sqlite3');
const path = require('path');

class TransferDatabase {
  constructor(dbPath) {
    this.db = new Database(dbPath);
    this.init();
  }

  init() {
    this.db.exec(`
      CREATE TABLE IF NOT EXISTS transfers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        file_path TEXT NOT NULL,
        file_size INTEGER NOT NULL,
        status TEXT DEFAULT 'pending',
        error TEXT,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(file_path, file_size)
      );
      
      CREATE INDEX IF NOT EXISTS idx_status ON transfers(status);
      CREATE INDEX IF NOT EXISTS idx_file_path ON transfers(file_path);
    `);
  }

  exportToCSV(outputPath) {
    const records = this.db.prepare('SELECT * FROM transfers').all();
    // å¯¦ä½œ CSV åŒ¯å‡ºé‚è¼¯
  }

  getStatistics() {
    return {
      total: this.db.prepare('SELECT COUNT(*) as count FROM transfers').get().count,
      completed: this.db.prepare('SELECT COUNT(*) as count FROM transfers WHERE status = ?').get('completed').count,
      failed: this.db.prepare('SELECT COUNT(*) as count FROM transfers WHERE status = ?').get('failed').count,
      pending: this.db.prepare('SELECT COUNT(*) as count FROM transfers WHERE status = ?').get('pending').count
    };
  }
}

module.exports = TransferDatabase;
```

### CLI å¯¦ä½œ (packages/cli/src/index.js)

```javascript
#!/usr/bin/env node
const { Command } = require('commander');
const chalk = require('chalk');
const cliProgress = require('cli-progress');
const { MTPWrapper, TransferManager, TransferDatabase } = require('@mtp-transfer/core');

const program = new Command();

program
  .name('mtp-transfer')
  .description('æ™ºæ…§ MTP æª”æ¡ˆå‚³è¼¸å·¥å…·')
  .version('1.0.0');

program
  .command('detect')
  .description('åµæ¸¬ MTP è£ç½®')
  .action(async () => {
    const mtp = new MTPWrapper();
    try {
      const device = await mtp.detectDevice();
      console.log(chalk.green('âœ“ æ‰¾åˆ°è£ç½®:'), device);
    } catch (error) {
      console.error(chalk.red('âœ— åµæ¸¬å¤±æ•—:'), error.message);
    }
  });

program
  .command('transfer <destination>')
  .description('é–‹å§‹å‚³è¼¸æª”æ¡ˆ')
  .option('-f, --filter <pattern>', 'æª”æ¡ˆç¯©é¸ (ä¾‹å¦‚: *.jpg)')
  .option('-d, --db <path>', 'è³‡æ–™åº«è·¯å¾‘', './transfer.db')
  .action(async (destination, options) => {
    const db = new TransferDatabase(options.db);
    const mtp = new MTPWrapper();
    
    // å»ºç«‹é€²åº¦æ¢
    const progressBar = new cliProgress.SingleBar({
      format: 'é€²åº¦ |{bar}| {percentage}% | {value}/{total} æª”æ¡ˆ | {file}',
      barCompleteChar: '\u2588',
      barIncompleteChar: '\u2591'
    });
    
    const manager = new TransferManager({
      db: db.db,
      onProgress: (data) => {
        progressBar.increment(1, { file: data.file });
      },
      onError: (data) => {
        console.error(chalk.red(`\nâœ— å‚³è¼¸å¤±æ•—: ${data.file}`));
      }
    });
    
    try {
      // å–å¾—æª”æ¡ˆåˆ—è¡¨
      console.log(chalk.blue('æ­£åœ¨æƒææª”æ¡ˆ...'));
      const phoneFiles = await mtp.listFiles();
      
      // å–å¾—å¾…å‚³è¼¸æª”æ¡ˆ
      const pendingFiles = await manager.getPendingFiles(phoneFiles);
      console.log(chalk.green(`æ‰¾åˆ° ${pendingFiles.length} å€‹å¾…å‚³è¼¸æª”æ¡ˆ`));
      
      // é–‹å§‹å‚³è¼¸
      progressBar.start(pendingFiles.length, 0);
      
      for (const file of pendingFiles) {
        await manager.transferFile(file, destination);
      }
      
      progressBar.stop();
      console.log(chalk.green('\nâœ“ å‚³è¼¸å®Œæˆï¼'));
      
      // é¡¯ç¤ºçµ±è¨ˆ
      const stats = db.getStatistics();
      console.log(chalk.blue('\nçµ±è¨ˆè³‡è¨Š:'));
      console.log(`  ç¸½æª”æ¡ˆæ•¸: ${stats.total}`);
      console.log(`  å·²å®Œæˆ: ${stats.completed}`);
      console.log(`  å¤±æ•—: ${stats.failed}`);
      
    } catch (error) {
      console.error(chalk.red('âœ— éŒ¯èª¤:'), error.message);
    }
  });

program
  .command('export <output>')
  .description('åŒ¯å‡ºå‚³è¼¸è¨˜éŒ„')
  .action(async (output) => {
    const db = new TransferDatabase('./transfer.db');
    await db.exportToCSV(output);
    console.log(chalk.green(`âœ“ å·²åŒ¯å‡ºè‡³ ${output}`));
  });

program.parse();
```

### å®‰è£èˆ‡ä½¿ç”¨

#### åˆå§‹åŒ–å°ˆæ¡ˆ
```bash
# å»ºç«‹å°ˆæ¡ˆ
mkdir mtp-transfer && cd mtp-transfer

# åˆå§‹åŒ– pnpm
pnpm init

# è¨­å®š workspace
echo "packages:\n  - 'packages/*'" > pnpm-workspace.yaml

# å»ºç«‹å¥—ä»¶ç›®éŒ„
mkdir -p packages/core/src packages/cli/src

# å®‰è£ä¾è³´
cd packages/core && pnpm init && pnpm add better-sqlite3
cd ../cli && pnpm init && pnpm add commander chalk cli-progress
pnpm add -D @mtp-transfer/core@workspace:*
```

#### ä½¿ç”¨ç¯„ä¾‹
```bash
# åµæ¸¬è£ç½®
mtp-transfer detect

# é–‹å§‹å‚³è¼¸
mtp-transfer transfer ~/Pictures/Phone

# åªå‚³è¼¸ç…§ç‰‡
mtp-transfer transfer ~/Pictures/Phone --filter "*.jpg"

# åŒ¯å‡ºè¨˜éŒ„
mtp-transfer export transfer-log.csv
```

### é–‹ç™¼éšæ®µ

#### Phase 1: æ ¸å¿ƒåŠŸèƒ½
- å»ºç«‹ monorepo çµæ§‹
- å¯¦ä½œ MTP wrapper
- å»ºç«‹è³‡æ–™åº«æ¨¡çµ„
- å®Œæˆæª”æ¡ˆæ¯”å°é‚è¼¯

#### Phase 2: CLI ä»‹é¢
- å¯¦ä½œåŸºæœ¬å‘½ä»¤
- åŠ å…¥é€²åº¦é¡¯ç¤º
- éŒ¯èª¤è™•ç†æ©Ÿåˆ¶
- çµ±è¨ˆè³‡è¨Šé¡¯ç¤º

#### Phase 3: é€²éšåŠŸèƒ½
- æª”æ¡ˆç¯©é¸åŠŸèƒ½
- æ‰¹æ¬¡è™•ç†å„ªåŒ–
- è‡ªå‹•é‡è©¦æ©Ÿåˆ¶
- è¨˜éŒ„åŒ¯å‡ºåŠŸèƒ½

#### Phase 4: GUI é–‹ç™¼ (æœªä¾†)
- Electron æ‡‰ç”¨ç¨‹å¼
- è¦–è¦ºåŒ–é€²åº¦é¡¯ç¤º
- æ‹–æ”¾ä»‹é¢
- è¨­å®šç®¡ç†

### é æœŸæˆæœ
- ç©©å®šå‚³è¼¸ 2000+ æª”æ¡ˆ
- æ”¯æ´æ–·é»çºŒå‚³
- æ¸…æ™°çš„é€²åº¦å›é¥‹
- å¯åŒ¯å‡ºå‚³è¼¸è¨˜éŒ„

## å¯¦æ©Ÿæ¸¬è©¦çµæœ

### âœ… å·²æ¸¬è©¦è£ç½®
- **Google Pixel 7a** - æˆåŠŸé€£æ¥ä¸¦åµæ¸¬
  - éœ€è¦æ‰‹æ©Ÿè¨­å®šç‚ºã€Œæª”æ¡ˆå‚³è¼¸ã€æ¨¡å¼
  - é¦–æ¬¡é€£æ¥å¯èƒ½éœ€è¦èª¿æ•´ USB è¨­å®š

### ä½¿ç”¨é«”é©—å›é¥‹
1. **é€£æ¥ç©©å®šæ€§**ï¼šç†±æ’æ‹”éƒ¨åˆ†æ”¯æ´ï¼Œéœ€æ‰‹å‹•é‡æ–°åµæ¸¬
2. **æƒæé€Ÿåº¦**ï¼šå¤§è³‡æ–™å¤¾ï¼ˆå¦‚ /Picturesï¼‰å¯èƒ½éœ€è¦ç­‰å¾…
3. **é€²åº¦é¡¯ç¤º**ï¼šä½¿ç”¨ `-r` åƒæ•¸å¯é¡¯ç¤ºæƒæé€²åº¦æ¢
4. **éŒ¯èª¤è™•ç†**ï¼šæ¸…æ¥šçš„ä¸­æ–‡éŒ¯èª¤æç¤ºï¼Œæ–¹ä¾¿æ’é™¤å•é¡Œ

### å¯¦éš›ä½¿ç”¨ç¯„ä¾‹
```bash
# åµæ¸¬è£ç½®
pnpm --filter @mtp-transfer/cli dev detect

# åˆ—å‡ºæ‰‹æ©Ÿç…§ç‰‡ï¼ˆé¡¯ç¤ºé€²åº¦ï¼‰
pnpm --filter @mtp-transfer/cli dev list /DCIM -r

# å‚³è¼¸ç…§ç‰‡åˆ°é›»è…¦
pnpm --filter @mtp-transfer/cli dev transfer /DCIM/Camera \
  --destination ~/Pictures/Pixel7a-Backup

# æŸ¥çœ‹å‚³è¼¸é€²åº¦
ç¸½é€²åº¦: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘] 85% | 127/150 æª”æ¡ˆ | 2.3 MB/s | ETA: 2åˆ†15ç§’
```
